##########################################################################
## This R script is used for the simulation studies in Appendix I 
## (Figures 6 & 7).
##########################################################################
## Data: Synthetic data
##########################################################################
## Instructions: This script reads the results from the simulation studies 
## generated by the R scripts 01_simulation_c_small.R and 01_simulation_c_large.R.
## You may run this R script to generate the figures.
##########################################################################

library(l1ideal)
library(posterior)
library(coda)
library(tidyverse)
library(patchwork)
library(here)
setwd(here("codes", "simulation"))

#  n_chain: 4 
#  mcmc_length: 50000 
#  thin_length: 10 
#  burnin_length: 20000 

##########
## Simulation: c = 1
##########
source("helper.R")
dat <- read_rds("../../data/simulation/tuning_param/sim_c_small_dat.rds")
res_list <- read_rds("../../data/simulation/tuning_param/sim_c_small.rds")
n_chain <- length(res_list)

## check whether the coordinates are flipped
p_ls <- map(1:n_chain, function(m) {
  p <- plot.simulation(dat, res_list[[m]], coord_flip = FALSE)
  return(p[[3]] + p[[4]])
})
p_ls[[1]] / p_ls[[2]] / p_ls[[3]] / p_ls[[4]]

## fix the coordinates
coord_flip_ls <- c(FALSE, FALSE, TRUE, TRUE)
p_ls <- map(1:n_chain, function(m) {
  p <- plot.simulation(dat, res_list[[m]], coord_flip = coord_flip_ls[m])
  return(p[[3]] + p[[4]])
})
## check whether the coordinates are correctly flipped
p_ls[[1]] / p_ls[[2]] / p_ls[[3]] / p_ls[[4]]

## it takes a while to run this code (to compute the convergence diagnostics)
## you may want to skip this line and load the saved results in the next line
res <- get_summary_chains(res_list, coord_flip_ls, rep(TRUE, 4), rep(TRUE, 4))
saveRDS(res, file = "data/simulation/tuning_param/sim_small_c_res_summary.rds")
res <- read_rds("data/simulation/tuning_param/sim_small_c_res_summary.rds")

p_res <- plot_legislator_chains(dat, res)
p_res[[1]] + p_res[[2]] + p_res[[3]] + p_res[[4]]
p_res_combined <- ((p_res[[1]] + theme(aspect.ratio=1)) + 
          (p_res[[2]] + theme(aspect.ratio=1)) + 
          (p_res[[3]] + theme(aspect.ratio=1)) + 
          (p_res[[4]] + theme(aspect.ratio=1))) + 
  plot_layout(ncol = 4) +
  plot_annotation(title = "Small window size (c = 1)")
ggsave("../../figure/sim_small_c.pdf", p_res_combined, width = 14, height = 4)

## running time
for(i in 1:n_chain) {
  cat("Chain ", i, " Running time: ", convert_seconds_to_hours(res_list[[i]]$running_time), "\n")
}
# Chain  1  Running time:  2.008 hours 
# Chain  2  Running time:  2.015 hours 
# Chain  3  Running time:  2.006 hours 
# Chain  4  Running time:  2.027 hours 

## rhat
rhat_p <- ggplot(res, aes(x = factor(dimension), y = rhat, fill = type)) +
  geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
  labs(x = "Dimension", y = expression(hat(R)), title = NULL) +
  theme_minimal() +
  ylim(0.999, 1.1) +
  geom_hline(yintercept = 1.1, linetype = "dashed", color = "red") +
  scale_fill_brewer(name = "Type", labels = c("Ideal Points", "Nay Positions", "Yea Positions"), palette = "Paired")
ggsave("../../figure/sim_small_c_rhat.pdf", rhat_p, width = 8, height = 4)

rm(list = ls())
##########
## Simulation: c = 8
##########
source("helper.R")
dat <- read_rds("../../data/simulation/tuning_param/sim_c_large_dat.rds")
res_list <- read_rds("../../data/simulation/tuning_param/sim_c_large.rds")
n_chain <- length(res_list)

## check whether the coordinates are flipped
p_ls <- map(1:n_chain, function(m) {
  p <- plot.simulation(dat, res_list[[m]], coord_flip = FALSE)
  return(p[[3]] + p[[4]])
})
p_ls[[1]] / p_ls[[2]] / p_ls[[3]] / p_ls[[4]]

## fix the coordinates
coord_flip_ls <- c(TRUE, FALSE, FALSE, TRUE)
p_ls <- map(1:n_chain, function(m) {
  p <- plot.simulation(dat, res_list[[m]], coord_flip = coord_flip_ls[m])
  return(p[[3]] + p[[4]])
})
## check whether the coordinates are correctly flipped
p_ls[[1]] / p_ls[[2]] / p_ls[[3]] / p_ls[[4]]

## it takes a while to run this code (to compute the convergence diagnostics)
## you may want to skip this line and load the saved results in the next line
res <- get_summary_chains(res_list, coord_flip_ls, rep(TRUE, 4), rep(TRUE, 4))
saveRDS(res, file = "data/simulation/tuning_param/sim_large_c_res_summary.rds")
res <- read_rds("data/simulation/tuning_param/sim_large_c_res_summary.rds")

p_res <- plot_legislator_chains(dat, res)
p_res[[1]] + p_res[[2]] + p_res[[3]] + p_res[[4]]
p_res_combined <- ((p_res[[1]] + theme(aspect.ratio=1)) + 
          (p_res[[2]] + theme(aspect.ratio=1)) + 
          (p_res[[3]] + theme(aspect.ratio=1)) + 
          (p_res[[4]] + theme(aspect.ratio=1))) + 
  plot_layout(ncol = 4) +
  plot_annotation(title = "Large window size (c = 8)")
ggsave("../../figure/sim_large_c.pdf", p_res_combined, width = 14, height = 4)

## running time
for(i in 1:n_chain) {
  cat("Chain ", i, " Running time: ", convert_seconds_to_hours(res_list[[i]]$running_time), "\n")
}
# Chain  1  Running time:  3.868 hours 
# Chain  2  Running time:  3.855 hours 
# Chain  3  Running time:  3.863 hours 
# Chain  4  Running time:  3.928 hours 

## rhat
rhat_p <- ggplot(res, aes(x = factor(dimension), y = rhat, fill = type)) +
  geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
  labs(x = "Dimension", y = expression(hat(R)), title = NULL) +
  theme_minimal() +
  ylim(0.999, 1.1) +
  geom_hline(yintercept = 1.1, linetype = "dashed", color = "red") +
  scale_fill_brewer(name = "Type", labels = c("Ideal Points", "Nay Positions", "Yea Positions"), palette = "Paired")
ggsave("../../figure/sim_large_c_rhat.pdf", rhat_p, width = 8, height = 4)
